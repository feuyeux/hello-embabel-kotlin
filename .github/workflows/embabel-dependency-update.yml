name: Embabel Dependency Update

on:
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡embabelä¾èµ–æ›´æ–°
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰embabelä¾èµ–'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  check-embabel-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-embabel-kotlin-${{ hashFiles('pom.xml') }}
          restore-keys: ${{ runner.os }}-m2-embabel-kotlin
      
      - name: Configure Maven settings for private repo
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>embabel-snapshots</id>
                <username>\${env.EMBABEL_REPO_USERNAME}</username>
                <password>\${env.EMBABEL_REPO_PASSWORD}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          EMBABEL_REPO_USERNAME: ${{ secrets.EMBABEL_REPO_USERNAME }}
          EMBABEL_REPO_PASSWORD: ${{ secrets.EMBABEL_REPO_PASSWORD }}
      
      - name: Check for embabel dependency updates
        id: check-updates
        run: |
          echo "æ£€æŸ¥embabelä¾èµ–æ›´æ–°..."
          
          # è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=embabel-agent.version -q -DforceStdout)
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # å…ˆç¡®ä¿èƒ½æ­£å¸¸è§£æä¾èµ–
          echo "éªŒè¯ä¾èµ–è®¿é—®..."
          mvn dependency:resolve -Dincludes=com.embabel.agent:* -q
          
          # å®‰å…¨åœ°æ¸…ç†SNAPSHOTç¼“å­˜ï¼ˆä¸é‡æ–°è§£æï¼‰
          echo "æ¸…ç†SNAPSHOTç¼“å­˜..."
          rm -rf ~/.m2/repository/com/embabel/agent/*/0.1.0-SNAPSHOT/maven-metadata-embabel-snapshots.xml || true
          rm -rf ~/.m2/repository/com/embabel/common/*/0.1.0/maven-metadata-embabel-snapshots.xml || true
          
          # è·å–å½“å‰SNAPSHOTçš„æ—¶é—´æˆ³
          echo "è·å–å½“å‰SNAPSHOTæ—¶é—´æˆ³..."
          CURRENT_TIMESTAMP=""
          if [ -f ~/.m2/repository/com/embabel/agent/embabel-agent-starter/0.1.0-SNAPSHOT/maven-metadata-embabel-snapshots.xml ]; then
            CURRENT_TIMESTAMP=$(grep -o '<timestamp>[^<]*</timestamp>' ~/.m2/repository/com/embabel/agent/embabel-agent-starter/0.1.0-SNAPSHOT/maven-metadata-embabel-snapshots.xml | head -1 | sed 's/<[^>]*>//g' || echo "")
          fi
          echo "å½“å‰æ—¶é—´æˆ³: $CURRENT_TIMESTAMP"
          
          # å¼ºåˆ¶åˆ·æ–°SNAPSHOTå…ƒæ•°æ®
          echo "å¼ºåˆ¶åˆ·æ–°SNAPSHOTå…ƒæ•°æ®..."
          mvn dependency:resolve -Dincludes=com.embabel.agent:* -U -q
          
          # è·å–æ–°çš„æ—¶é—´æˆ³
          NEW_TIMESTAMP=""
          if [ -f ~/.m2/repository/com/embabel/agent/embabel-agent-starter/0.1.0-SNAPSHOT/maven-metadata-embabel-snapshots.xml ]; then
            NEW_TIMESTAMP=$(grep -o '<timestamp>[^<]*</timestamp>' ~/.m2/repository/com/embabel/agent/embabel-agent-starter/0.1.0-SNAPSHOT/maven-metadata-embabel-snapshots.xml | head -1 | sed 's/<[^>]*>//g' || echo "")
          fi
          echo "æ–°æ—¶é—´æˆ³: $NEW_TIMESTAMP"
          
          # æ¯”è¾ƒæ—¶é—´æˆ³åˆ¤æ–­æ˜¯å¦æœ‰æ›´æ–°
          if [ -n "$NEW_TIMESTAMP" ] && [ "$NEW_TIMESTAMP" != "$CURRENT_TIMESTAMP" ]; then
            echo "å‘ç°æ–°çš„SNAPSHOTæ„å»º: $NEW_TIMESTAMP"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "latest_info=æ–°SNAPSHOTæ„å»ºæ—¶é—´: $NEW_TIMESTAMP" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            echo "å¼ºåˆ¶æ›´æ–°æ¨¡å¼"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "latest_info=å¼ºåˆ¶æ›´æ–°SNAPSHOTä¾èµ–" >> $GITHUB_OUTPUT
          else
            echo "æ²¡æœ‰å‘ç°æ–°çš„SNAPSHOTæ„å»º"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
        env:
          EMBABEL_REPO_USERNAME: ${{ secrets.EMBABEL_REPO_USERNAME }}
          EMBABEL_REPO_PASSWORD: ${{ secrets.EMBABEL_REPO_PASSWORD }}
      
      - name: Update embabel dependencies
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          echo "æ›´æ–°embabelä¾èµ–..."
          
          # å®‰å…¨åœ°æ¸…ç†SNAPSHOTç¼“å­˜
          echo "æ¸…ç†æœ¬åœ°SNAPSHOTç¼“å­˜..."
          rm -rf ~/.m2/repository/com/embabel/agent/*/0.1.0-SNAPSHOT/*.jar || true
          rm -rf ~/.m2/repository/com/embabel/agent/*/0.1.0-SNAPSHOT/*.pom || true
          rm -rf ~/.m2/repository/com/embabel/common/*/0.1.0/*.jar || true
          rm -rf ~/.m2/repository/com/embabel/common/*/0.1.0/*.pom || true
          
          # å¼ºåˆ¶é‡æ–°ä¸‹è½½å’Œç¼–è¯‘
          mvn clean compile -U
          
          # è®°å½•æ›´æ–°ä¿¡æ¯
          echo "no_changes=false" >> $GITHUB_ENV
          
          # è·å–å½“å‰ç‰ˆæœ¬ï¼ˆè™½ç„¶ç‰ˆæœ¬å·å¯èƒ½ç›¸åŒï¼Œä½†SNAPSHOTå†…å®¹å·²æ›´æ–°ï¼‰
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=embabel-agent.version -q -DforceStdout)
          echo "new_version=$CURRENT_VERSION" >> $GITHUB_ENV
          
          # è·å–æ–°çš„æ—¶é—´æˆ³ä½œä¸ºæ ‡è¯†
          NEW_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "update_timestamp=$NEW_TIMESTAMP" >> $GITHUB_ENV
        env:
          EMBABEL_REPO_USERNAME: ${{ secrets.EMBABEL_REPO_USERNAME }}
          EMBABEL_REPO_PASSWORD: ${{ secrets.EMBABEL_REPO_PASSWORD }}
      
      - name: Run tests with new dependencies
        if: env.no_changes == 'false'
        run: |
          echo "ä½¿ç”¨æ–°ä¾èµ–è¿è¡Œæµ‹è¯•..."
          mvn clean test
        env:
          EMBABEL_REPO_USERNAME: ${{ secrets.EMBABEL_REPO_USERNAME }}
          EMBABEL_REPO_PASSWORD: ${{ secrets.EMBABEL_REPO_PASSWORD }}
      
      - name: Create Pull Request
        if: env.no_changes == 'false'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "deps: update embabel-agent to ${{ env.new_version }}"
          title: "ğŸ¤– Update embabel-agent dependencies"
          body: |
            ## Embabelä¾èµ–è‡ªåŠ¨æ›´æ–°
            
            è¿™ä¸ªPRè‡ªåŠ¨æ›´æ–°äº†embabel-agentç›¸å…³ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚
            
            ### å˜æ›´å†…å®¹
            - æ›´æ–° `embabel-agent.version` åˆ° `${{ env.new_version }}`
            
            ### æ›´æ–°ä¿¡æ¯
            ```
            ${{ steps.check-updates.outputs.latest_info }}
            ```
            
            ### éªŒè¯çŠ¶æ€
            - âœ… æµ‹è¯•é€šè¿‡
            - âœ… ä¾èµ–å†²çªæ£€æŸ¥
            
            è¿™ä¸ªPRä¼šè‡ªåŠ¨åˆå¹¶ï¼Œå¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ã€‚
          branch: "embabel-deps/update-${{ env.new_version }}"
          labels: |
            dependencies
            embabel
            automerge
          reviewers: |
            feuyeux
      
      - name: Auto-merge embabel updates
        if: env.no_changes == 'false'
        run: |
          # ç­‰å¾…PRåˆ›å»ºå®Œæˆ
          sleep 10
          
          # è·å–PRå·ç 
          PR_NUMBER=$(gh pr list --head "embabel-deps/update-${{ env.new_version }}" --json number --jq '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "è‡ªåŠ¨æ‰¹å‡†å¹¶åˆå¹¶PR #$PR_NUMBER"
            gh pr review $PR_NUMBER --approve
            gh pr merge $PR_NUMBER --auto --squash
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}