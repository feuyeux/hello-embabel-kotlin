name: Embabel Dependency Update

on:
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡embabelä¾èµ–æ›´æ–°
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰embabelä¾èµ–'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  check-embabel-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-embabel-kotlin-${{ hashFiles('pom.xml') }}
          restore-keys: ${{ runner.os }}-m2-embabel-kotlin
      
      - name: Configure Maven settings for private repo
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>embabel-snapshots</id>
                <username>\${env.EMBABEL_REPO_USERNAME}</username>
                <password>\${env.EMBABEL_REPO_PASSWORD}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          EMBABEL_REPO_USERNAME: ${{ secrets.EMBABEL_REPO_USERNAME }}
          EMBABEL_REPO_PASSWORD: ${{ secrets.EMBABEL_REPO_PASSWORD }}
      
      - name: Check for embabel dependency updates
        id: check-updates
        run: |
          echo "æ£€æŸ¥embabelä¾èµ–æ›´æ–°..."
          
          # è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=embabel-agent.version -q -DforceStdout)
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # æ£€æŸ¥å¯ç”¨ç‰ˆæœ¬
          mvn versions:display-dependency-updates -Dincludes=com.embabel.agent:* > dependency-updates.log 2>&1 || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if grep -q "com.embabel.agent" dependency-updates.log; then
            echo "å‘ç°embabelä¾èµ–æ›´æ–°"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            
            # æå–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
            LATEST_INFO=$(grep -A 2 "com.embabel.agent" dependency-updates.log | head -3)
            echo "latest_info<<EOF" >> $GITHUB_OUTPUT
            echo "$LATEST_INFO" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "æ²¡æœ‰å‘ç°embabelä¾èµ–æ›´æ–°"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
        env:
          EMBABEL_REPO_USERNAME: ${{ secrets.EMBABEL_REPO_USERNAME }}
          EMBABEL_REPO_PASSWORD: ${{ secrets.EMBABEL_REPO_PASSWORD }}
      
      - name: Update embabel dependencies
        if: steps.check-updates.outputs.has_updates == 'true' || github.event.inputs.force_update == 'true'
        run: |
          echo "æ›´æ–°embabelä¾èµ–..."
          
          # æ›´æ–°åˆ°æœ€æ–°SNAPSHOTç‰ˆæœ¬
          mvn versions:use-latest-snapshots -Dincludes=com.embabel.agent:*
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if git diff --quiet pom.xml; then
            echo "æ²¡æœ‰å®é™…çš„ç‰ˆæœ¬å˜æ›´"
            echo "no_changes=true" >> $GITHUB_ENV
          else
            echo "å‘ç°ç‰ˆæœ¬å˜æ›´"
            echo "no_changes=false" >> $GITHUB_ENV
            
            # è·å–æ–°ç‰ˆæœ¬
            NEW_VERSION=$(mvn help:evaluate -Dexpression=embabel-agent.version -q -DforceStdout)
            echo "new_version=$NEW_VERSION" >> $GITHUB_ENV
          fi
        env:
          EMBABEL_REPO_USERNAME: ${{ secrets.EMBABEL_REPO_USERNAME }}
          EMBABEL_REPO_PASSWORD: ${{ secrets.EMBABEL_REPO_PASSWORD }}
      
      - name: Run tests with new dependencies
        if: env.no_changes == 'false'
        run: |
          echo "ä½¿ç”¨æ–°ä¾èµ–è¿è¡Œæµ‹è¯•..."
          mvn clean test
        env:
          EMBABEL_REPO_USERNAME: ${{ secrets.EMBABEL_REPO_USERNAME }}
          EMBABEL_REPO_PASSWORD: ${{ secrets.EMBABEL_REPO_PASSWORD }}
      
      - name: Create Pull Request
        if: env.no_changes == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "deps: update embabel-agent to ${{ env.new_version }}"
          title: "ğŸ¤– Update embabel-agent dependencies"
          body: |
            ## Embabelä¾èµ–è‡ªåŠ¨æ›´æ–°
            
            è¿™ä¸ªPRè‡ªåŠ¨æ›´æ–°äº†embabel-agentç›¸å…³ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚
            
            ### å˜æ›´å†…å®¹
            - æ›´æ–° `embabel-agent.version` åˆ° `${{ env.new_version }}`
            
            ### æ›´æ–°ä¿¡æ¯
            ```
            ${{ steps.check-updates.outputs.latest_info }}
            ```
            
            ### éªŒè¯çŠ¶æ€
            - âœ… æµ‹è¯•é€šè¿‡
            - âœ… ä¾èµ–å†²çªæ£€æŸ¥
            
            è¿™ä¸ªPRä¼šè‡ªåŠ¨åˆå¹¶ï¼Œå¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ã€‚
          branch: "embabel-deps/update-${{ env.new_version }}"
          labels: |
            dependencies
            embabel
            automerge
          reviewers: |
            feuyeux
      
      - name: Auto-merge embabel updates
        if: env.no_changes == 'false'
        run: |
          # ç­‰å¾…PRåˆ›å»ºå®Œæˆ
          sleep 10
          
          # è·å–PRå·ç 
          PR_NUMBER=$(gh pr list --head "embabel-deps/update-${{ env.new_version }}" --json number --jq '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "è‡ªåŠ¨æ‰¹å‡†å¹¶åˆå¹¶PR #$PR_NUMBER"
            gh pr review $PR_NUMBER --approve
            gh pr merge $PR_NUMBER --auto --squash
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}